#!/bin/zsh

# https://unix.stackexchange.com/questions/76505/unix-portable-way-to-get-scripts-absolute-path-in-zsh
self=${0:a}
scriptdir=${0:a:h}

libName="pogp_demo"
unityPackageId="com.pogp.unitypkg"
projectRoot="$scriptdir/.."
unityProjectDir="$projectRoot/unity/PogProtocolDemo"
unityPluginDir="$unityProjectDir/Assets/Plugins/Editor"
unityScriptsDir="$unityProjectDir/Assets/Scripts"
demoLibPath="$projectRoot/demo/target/debug/lib$libName.dylib"

case "$1" in
	build)
		(cd rs && wasm-pack build)
		;;

	bump)
		lastVersion=$(cat "$projectRoot/version")
		# https://stackoverflow.com/questions/8653126/how-to-increment-version-number-in-a-shell-script
		version=$(cat "$projectRoot/version" | awk -vFS=. -vOFS=. '{$NF++;print}')
		# https://stackoverflow.com/questions/38021348/how-can-i-echo-out-things-without-a-newline
		sed -i '' "s/$lastVersion/$version/g" version
		sed -i '' "s/$lastVersion/$version/g" "$projectRoot/demo/Cargo.toml"
		sed -i '' "s/$lastVersion/$version/g" "$projectRoot/ts/package.json"
		sed -i '' "s/$lastVersion/$version/g" "$unityProjectDir/Packages/$unityPackageId/package.json"
		sed -i '' "s/$lastVersion/$version/g" "README.md"
		echo "Bumped version to $version"
		;;

	dev)
		# sq: ctrl+c to interrupt both from sh script
		(cd demo && yarn dev)
		;;

	install)
		which rustup &> /dev/null || curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
		which wasm-pack &> /dev/null || curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh
		which yarn &> /dev/null || npm install --global yarn
		(cd ts && yarn)
		;;

	test)
		(cd ts && yarn test) || exit 1
		(cd rs && cargo test) || exit 1
		;;

	unityWatch)
		(cd demo && cargo watch -w src -s "$self buildUnity")
		;;
	unityBuild)
		(cd "$projectRoot/demo" && cargo build)
		id=$(uuidgen)
		mkdir -p "$unityPluginDir"
		mkdir -p "$unityScriptsDir"
		# remove old generated files and metafiles
		rm "$unityPluginDir/$libName"-*.dylib* &> /dev/null
		cp "$demoLibPath" "$unityPluginDir/$libName-$id.dylib"

		tee > "$unityScriptsDir/PogpNativeVersion.cs" <<EOF
// Code generated by .bin/pog, do not edit manually
public static class PogpNativeVersion {
#if UNITY_EDITOR
	public const string LibName = "$libName-$id";
#else
	// todo: copy version automatically on build with
	// https://docs.unity3d.com/ScriptReference/Build.IPreprocessBuildWithReport.OnPreprocessBuild.html
	public const string LibName = "$libName";
#endif
}
EOF

		tee > "$unityScriptsDir/PogpNative.cs" << EOF
using System;
using System.Runtime.InteropServices;

// Code generated by .bin/pog, do not edit manually
// See https://blog.testdouble.com/posts/2018-07-31-complex-ffi-rust-unity-node/ for Baton idea
public static class PogpNative {
	public const string libName = PogpNativeVersion.LibName;

	[DllImport(libName)]
	public static extern void pogp_start(out IntPtr baton, out GameState g);

	[DllImport(libName)]
	public static extern GameState pogp_tick(IntPtr baton, long frame, byte[] inputs, int len);
}
EOF

		tee > "$unityScriptsDir/GameState.cs" << EOF
using System;
using System.Runtime.InteropServices;

[StructLayout(LayoutKind.Sequential)]
[Serializable]
public class GameState {
    public Paddle p0;
    public Paddle p1;
    public Ball ball;
    public Int32 p0Score;
    public Int32 p1Score;
}

[StructLayout(LayoutKind.Sequential)]
[Serializable]
public struct Paddle {
	public float x;
	public float y;
	public float w;
	public float h;
}

[StructLayout(LayoutKind.Sequential)]
[Serializable]
public struct Ball {
	public float x;
	public float y;
	public float w;
	public float h;
	public Vector2 v;
}

[StructLayout(LayoutKind.Sequential)]
[Serializable]
public struct Vector2 {
	public float x;
	public float y;
}
EOF
		;;

	*)
		echo "Usage:"
		echo "ðŸ†™ pog bump       - bump version number"
		echo "ðŸ’¾ pog install    - install dependencies"
		echo "ðŸ›   pog dev        - live reload of rust and typescript"
		echo "âœ… pog test       - run unit tests"
		echo "ðŸ—  pog build      - build for web deployment"
		echo "ðŸ—‘  pog unityBuild - build for unity"
		echo "ðŸ—‘  pog unityWatch - watch unity"
		;;
esac
